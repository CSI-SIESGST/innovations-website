<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>


    <title>User Chat</title>

    <script type="text/javascript">
        function btnChange(x) {
            if(x>0)
            {
                document.getElementsByTagName('button')[0].removeAttribute('disabled')
            }
            else
            {
                document.getElementsByTagName('button')[0].setAttribute('disabled','')
            }
        }
    </script>
</head>
<body style="margin: 0;">
    <div style="display: flex; flex-direction: column; height: 100vh;">
        <div style="flex-grow: 1; overflow-y: none; position: relative; width: 100%;">
            <div id="chats" style="overflow: auto; position: absolute; width: 100%; bottom: 0; max-height: 100%;">
                <!-- <div class="ml-auto my-1 mr-3" style="max-width: 90%; text-align: right;">
                    <div style="padding: 5px 10px; text-align: justify; display: inline-block; background: #bbb; border-radius: 5px;">
                        hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello hello
                    </div>
                </div> -->
                <% chat.messages.forEach(message => {
                    if(!message.sender)
                    {
                        %>
                        <div class="ml-auto my-1 mr-3" style="max-width: 80%; text-align: right;">
                            <div style="padding: 5px 10px; text-align: justify; display: inline-block; background: #bbb; border-radius: 5px;">
                                <%= message.message %>
                            </div>
                        </div>
                        <%
                    }
                    else
                    {
                        %>
                        <div class="mr-auto my-1 ml-3" style="max-width: 80%; text-align: left;">
                            <div style="padding: 5px 10px; text-align: justify; display: inline-block; background: #dedede; border-radius: 5px;">
                                <%= message.message %>
                            </div>
                        </div>
                        <%
                    }
                }); %>
            </div>
        </div>
        
        <div id="input-cont" style="display: flex; flex-direction: row; padding: 10px;">
            <textarea onkeyup="btnChange(this.value.trim().length);" onchange="btnChange(this.value.trim().length);" type="text" name="" id="input" rows="3" style="flex-grow: 1; resize: none;"></textarea>
            <button onclick="sendMessage();" disabled>Send</button>
        </div>
    </div>
    
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>

    <script>
        const socket = io('/');

        socket.emit('join-room', '<%= chat._id %>');

        socket.on('refresh', () => {
            alert('Error Occurred! Refreshing...');
            location.reload();
        });

        socket.on('new-msg', (teamName, message) => {
            var element = document.createElement('div');
            element.setAttribute('class', 'mr-auto my-1 ml-3');
            element.setAttribute('style', 'max-width: 90%; text-align: left;');
            
            element.innerHTML = '<div style="padding: 5px 10px; text-align: justify; display: inline-block; background: #dedede; border-radius: 5px;">'+message+'</div>';
            document.getElementById('chats').append(element);
        })

        function sendMessage() {
            var msg = document.getElementById('input').value.trim();
            if(msg.length>0)
            {
                var element = document.createElement('div');
                element.setAttribute('class', 'ml-auto my-1 mr-3');
                element.setAttribute('style', 'max-width: 90%; text-align: right;');
                element.innerHTML = '<div style="padding: 5px 10px; text-align: justify; display: inline-block; background: #bbb; border-radius: 5px;">'+msg.split('\n').join('<br>')+'</div>';

                socket.emit('msg-to-admin', '<%= chat.teamName %>', msg.split('\n').join('<br>'), '<%= chat._id %>')

                document.getElementById('chats').append(element);

                document.getElementById('input').value = '';

                document.getElementById('chats').scrollTop = document.getElementById('chats').scrollHeight;
            }
            else
            {
                return;
            }
        }
    </script>
</body>
</html>